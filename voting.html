<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const ballot = document.querySelector('.ballot');
    const errorMsg = document.getElementById('error-message');
    const submitBtn = document.getElementById('submit-ballot');
    const usernameInput = document.getElementById('username');
    
    // Candidate data - separated from presentation for better control
    const candidateGroups = [
        {
            name: "RENEW KAZJISTAN â€” RESTORE DEMOCRACY",
            candidates: [
                "Seat", "Cryzed", "Igor Witback", "Axell Nevylym", 
                "Emacia", "Fixie", "Timus Maximus", "aeropitz"
            ]
        },
        {
            name: "INDEPENDENTS",
            candidates: [
                "Bigurethra", "Clover", "Adam", "Joe Sane", "CSGPlayz"
            ]
        }
    ];
    const totalCandidates = candidateGroups.reduce((sum, group) => sum + group.candidates.length, 0);

    // Initialize ballot with randomized order
    function initializeBallot() {
        const ballotContainer = document.querySelector('.ballot-container');
        ballotContainer.innerHTML = ''; // Clear existing content
        
        // Create randomized groups
        candidateGroups.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'party-group';
            
            const partyName = document.createElement('div');
            partyName.className = 'party-name';
            partyName.textContent = group.name;
            groupDiv.appendChild(partyName);
            
            // Shuffle candidates with enhanced randomization
            const shuffledCandidates = robustShuffle([...group.candidates], usernameInput.value);
            
            // Add candidate inputs
            shuffledCandidates.forEach(candidate => {
                const candidateDiv = document.createElement('div');
                candidateDiv.className = 'candidate';
                
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.max = totalCandidates.toString();
                input.className = 'preference';
                input.placeholder = '-';
                input.dataset.candidate = candidate;
                
                const span = document.createElement('span');
                span.textContent = candidate;
                
                candidateDiv.appendChild(input);
                candidateDiv.appendChild(span);
                groupDiv.appendChild(candidateDiv);
            });
            
            ballotContainer.appendChild(groupDiv);
        });
    }

    // Enhanced shuffling algorithm with seed option
    function robustShuffle(array, seed = '') {
        // Create a seed value if provided
        let numericSeed = 0;
        if (seed) {
            for (let i = 0; i < seed.length; i++) {
                numericSeed += seed.charCodeAt(i) * (i + 1);
            }
        } else {
            numericSeed = Math.floor(Math.random() * 1000000);
        }
        
        // Seeded Fisher-Yates shuffle
        for (let i = array.length - 1; i > 0; i--) {
            // Generate pseudo-random index using the seed
            numericSeed = (numericSeed * 9301 + 49297) % 233280;
            const randomValue = numericSeed / 233280;
            const j = Math.floor(randomValue * (i + 1));
            
            // Swap elements
            [array[i], array[j]] = [array[j], array[i]];
        }
        
        return array;
    }

    // Validation functions
    function validateInput(input) {
        const value = parseInt(input.value);
        const inputs = document.querySelectorAll('.preference');
        
        // Check if number is too high
        if (value > totalCandidates) {
            return `Error: Maximum preference is ${totalCandidates}.`;
        }
        
        // Check for duplicates
        let duplicates = 0;
        inputs.forEach(otherInput => {
            if (otherInput !== input && otherInput.value === input.value) {
                duplicates++;
            }
        });
        
        if (duplicates > 0) {
            return `Error: Number ${input.value} is used more than once.`;
        }
        
        return '';
    }

    function validateBallot() {
        const inputs = Array.from(document.querySelectorAll('.preference'));
        
        // Check username is filled
        if (!usernameInput.value.trim()) {
            return "Error: Please enter your username.";
        }
        
        // Check all boxes are filled
        const emptyInputs = inputs.filter(input => input.value === "");
        if (emptyInputs.length > 0) {
            return "Error: You must number ALL candidates (1 to " + totalCandidates + ").";
        }
        
        // Check all numbers are unique
        const numbers = inputs.map(input => parseInt(input.value));
        if (new Set(numbers).size !== totalCandidates) {
            return "Error: Duplicate numbers detected.";
        }
        
        // Check numbers are within range
        const invalidNumbers = numbers.filter(n => n < 1 || n > totalCandidates);
        if (invalidNumbers.length > 0) {
            return `Error: Preferences must be between 1 and ${totalCandidates}.`;
        }
        
        return '';
    }

    // Event listeners
    function setupEventListeners() {
        // Input validation
        document.querySelectorAll('.preference').forEach(input => {
            input.addEventListener('change', function() {
                errorMsg.textContent = validateInput(this);
            });
        });
        
        // Form submission
        submitBtn.addEventListener('click', function() {
            const validationError = validateBallot();
            if (validationError) {
                errorMsg.textContent = validationError;
                return;
            }
            
            // Success!
            errorMsg.textContent = "Ballot submitted successfully!";
            errorMsg.style.color = "green";
            
            // Log results
            const votes = Array.from(document.querySelectorAll('.preference'))
                .map(input => ({
                    candidate: input.dataset.candidate,
                    preference: input.value
                }))
                .sort((a, b) => a.preference - b.preference);
            
            console.log("Voter:", usernameInput.value.trim());
            console.log("Votes:", votes);
            
            // Here you would normally submit to your server
            // submitVotes(usernameInput.value.trim(), votes);
        });
        
        // Re-randomize on username change (optional)
        usernameInput.addEventListener('input', function() {
            if (this.value.length > 3) { // Only shuffle after some input
                initializeBallot();
                setupEventListeners(); // Reattach event listeners to new inputs
            }
        });
    }

    // Initialize the ballot
    initializeBallot();
    setupEventListeners();
});

// Optional: Google Sheets submission
document.getElementById('submit-ballot').addEventListener('click', async function() {
    // ... [previous validation checks] ...
    
    const formData = new FormData();
    formData.append('timestamp', new Date().toISOString());
    formData.append('username', document.getElementById('username').value.trim());
    
    Array.from(document.querySelectorAll('.preference'))
        .sort((a, b) => parseInt(a.value) - parseInt(b.value))
        .forEach(input => {
            formData.append(input.dataset.candidate, input.value);
        });

    try {
        const response = await fetch(
            'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec',
            { method: 'POST', body: formData }
        );
        
        if (!response.ok) throw new Error("Failed to save");
    } catch (error) {
        console.error(error);
    }
});
</script>
