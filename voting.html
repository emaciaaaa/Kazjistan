<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Ballot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .ballot {
            background-color: white;
            border: 2px solid #000;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .ballot-container {
            display: flex;
            gap: 15px;
        }
        .party-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .party-header {
            border: 2px solid #000;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            background-color: #f0f0f0;
        }
        .party-group {
            border: 2px solid #000;
            padding: 15px;
        }
        .party-option {
            display: flex;
            align-items: center;
            margin: 10px 0;
            justify-content: center;
        }
        .party-option input {
            width: 40px;
            height: 30px;
            margin-right: 10px;
            text-align: center;
            font-size: 16px;
        }
        .candidate {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .candidate input {
            width: 40px;
            height: 30px;
            margin-right: 10px;
            text-align: center;
            font-size: 16px;
        }
        .error {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        button {
            display: block;
            margin: 20px auto 0;
            padding: 10px 20px;
            background-color: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0055aa;
        }
        .instructions {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        .username-input {
            margin-top: 20px;
            text-align: center;
        }
        .username-input input {
            padding: 8px;
            font-size: 16px;
            width: 200px;
        }
        .voting-method {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        .divider {
            border-top: 3px solid black;
            margin: 20px 0;
            position: relative;
        }
        .divider-text {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            font-weight: bold;
        }
        .above-the-line {
            margin-bottom: 30px;
        }
        .below-the-line {
            margin-top: 30px;
        }
        .requirement {
            font-style: italic;
            color: #555;
            margin-top: 5px;
        }
        .referendum {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #000;
            background-color: #f9f9f9;
        }
        .referendum h3 {
            margin-top: 0;
            color: #333;
        }
        .referendum p {
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .referendum-input {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }
        .referendum-input input {
            width: 100px;
            height: 30px;
            padding: 5px;
            font-size: 16px;
            text-align: center;
            margin-right: 10px;
        }
        .referendum-input label {
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .ballot-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="ballot">
        <h2 style="text-align: center;">Official Election Ballot</h2>
        
        <div class="voting-method">VOTE EITHER ABOVE THE LINE (FOR PARTIES) OR BELOW THE LINE (FOR CANDIDATES) - NOT BOTH</div>
        
        <!-- Above the line section -->
        <div class="above-the-line">
            <p class="instructions">ABOVE THE LINE - VOTE FOR PARTIES</p>
            <p class="requirement">(Number ALL 4 boxes in order of preference 1-4)</p>
            <div class="ballot-container">
                <!-- Whig Column -->
                <div class="party-column">
                    <div class="party-header">
                        <div class="party-option">
                            <input type="number" min="1" max="4" class="party-preference" placeholder="-" data-party="WHIG">
                            <span>WHIG</span>
                        </div>
                    </div>
                </div>
                
                <!-- Progressive Column -->
                <div class="party-column">
                    <div class="party-header">
                        <div class="party-option">
                            <input type="number" min="1" max="4" class="party-preference" placeholder="-" data-party="PROGRESSIVE">
                            <span>PROGRESSIVE</span>
                        </div>
                    </div>
                </div>
                
                <!-- Revolt! Column -->
                <div class="party-column">
                    <div class="party-header">
                        <div class="party-option">
                            <input type="number" min="1" max="4" class="party-preference" placeholder="-" data-party="REVOLT!">
                            <span>REVOLT!</span>
                        </div>
                    </div>
                </div>
                
                <!-- Meg Column -->
                <div class="party-column">
                    <div class="party-header">
                        <div class="party-option">
                            <input type="number" min="1" max="4" class="party-preference" placeholder="-" data-party="MEG">
                            <span>MEG</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Divider line -->
        <div class="divider">
            <span class="divider-text">OR</span>
        </div>
        
        <!-- Below the line section -->
        <div class="below-the-line">
            <p class="instructions">BELOW THE LINE - VOTE FOR CANDIDATES</p>
            <p class="requirement">(Number AT LEAST 8 boxes in order of preference 1-22)</p>
            <div class="ballot-container">
                <!-- Whig Column -->
                <div class="party-column">
                    <div class="party-group">
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Joe Sane">
                            <span>Joe Sane</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Elite">
                            <span>Elite</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Zelvrix">
                            <span>Zelvrix</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Hope">
                            <span>Hope</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="EstoBlake">
                            <span>EstoBlake</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Zeynep">
                            <span>Zeynep</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Fevsear">
                            <span>Fevsear</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Goodquestion">
                            <span>Goodquestion</span>
                        </div>
                    </div>
                </div>
                
               <!-- Progressive Column (updated section) -->
<div class="party-column">
    <div class="party-group">
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Igor Witback">
            <span>Igor Witback</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Axell Nevylym">
            <span>Axell Nevylym</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Timus Maximus">
            <span>Timus Maximus</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Emacia">
            <span>Emacia</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Fixie">
            <span>Fixie</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Cyrzed">
            <span>Cyrzed</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Aeropitz">
            <span>Aeropitz</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Baraa">
            <span>Baraa</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Coca-Cola King">
            <span>Coca-Cola King</span>
        </div>
        <div class="candidate">
            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Dinobop">
            <span>Dinobop</span>
        </div>
    </div>
</div>
                
                <!-- Revolt! Column -->
                <div class="party-column">
                    <div class="party-group">
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Clover">
                            <span>Clover</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Luci">
                            <span>Luci</span>
                        </div>
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Cisco">
                            <span>Cisco</span>
                        </div>
                    </div>
                </div>
                
                <!-- Meg Column -->
                <div class="party-column">
                    <div class="party-group">
                        <div class="candidate">
                            <input type="number" min="1" max="22" class="candidate-preference" placeholder="-" data-candidate="Meg">
                            <span>Meg</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Referendum Propositions -->
        <div class="referendum">
            <h3>Referendum Proposition 1</h3>
            <p>Do you agree with inserting the following article after twenty-eight, thereby shifting each following article by one digit?</p>
            <p><strong>Article Twenty-Nine:</strong> The Judiciary shall not unduly delay proceedings without just cause, and must adjudicate cases in a timely manner. Justices found to partake in deliberate or unreasonable postponements of proceedings are to be removed by Parliament.</p>
            <div class="referendum-input">
                <input type="text" id="referendum1" placeholder="yes or no" pattern="^(yes|no)$" required>
                <label for="referendum1">Your vote (yes/no):</label>
            </div>
        </div>

        <div class="referendum">
            <h3>Referendum Proposition 2</h3>
            <p>Do you agree with inserting the following article after fifty-seven, thereby shifting each following article by one digit?</p>
            <p><strong>Fifty-Eight:</strong> The government shall not establish, impose, or enforce any centralised economic, monetary, or financial system, nor shall it create institutions, regulations, or mechanisms that effectively constitute such a system, whether in whole or in part, directly or indirectly. No government or citizen shall institute financial, monetary, currency, or economic systems within Kazjistan, including central banks, private financial institutions, or external organizations purporting to act on behalf of the Kazji state. This prohibition extends to all claims of state endorsement, de facto financial structures, or circumvention through external entities.</p>
            <div class="referendum-input">
                <input type="text" id="referendum2" placeholder="yes or no" pattern="^(yes|no)$" required>
                <label for="referendum2">Your vote (yes/no):</label>
            </div>
        </div>

        <!-- Username Input -->
        <div class="username-input">
            <label for="username">Username:</label>
            <input type="text" id="username" required placeholder="Enter your username">
        </div>
        
        <div class="error" id="error-message"></div>
        <button id="submit-ballot">Submit Ballot</button>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const errorMsg = document.getElementById('error-message');
        const submitBtn = document.getElementById('submit-ballot');
        const usernameInput = document.getElementById('username');
        const partyPreferences = document.querySelectorAll('.party-preference');
        const candidatePreferences = document.querySelectorAll('.candidate-preference');
        const referendum1Input = document.getElementById('referendum1');
        const referendum2Input = document.getElementById('referendum2');
        
        // Candidate data (GROUPED by party for randomization)
        const candidateGroups = [
            {
                name: "WHIG",
                candidates: ["Joe Sane", "Elite", "Zelvrix", "Hope", "EstoBlake", "Zeynep", "Fevsear", "Goodquestion"]
            },
            {
                name: "PROGRESSIVE",
                candidates: ["Igor Witback", "Axell Nevylym", "Timus Maximus", "Emacia", "Fixie", "Cyrzed", "Aeropitz", "Baraa", "Coca-Cola King", "Dinobop"]
            },
            {
                name: "REVOLT!",
                candidates: ["Clover", "Luci", "Cisco"]
            },
            {
                name: "MEG",
                candidates: ["Meg"]
            }
        ];
        const totalCandidates = 22; // Whig:8 + Progressive:10 + Revolt!:3 + Meg:1

        // ===== RANDOMIZATION FUNCTIONS =====
        function initializeBallot() {
            const aboveLineContainer = document.querySelector('.above-the-line .ballot-container');
            const belowLineContainer = document.querySelector('.below-the-line .ballot-container');
            
            // Shuffle the order of parties (columns)
            const shuffledGroups = shuffleArray([...candidateGroups]);
            
            // Clear existing columns
            aboveLineContainer.innerHTML = '';
            belowLineContainer.innerHTML = '';
            
            // Create columns for each party
            shuffledGroups.forEach(group => {
                // Above the line (party voting)
                const aboveColumnDiv = document.createElement('div');
                aboveColumnDiv.className = 'party-column';
                
                const partyHeader = document.createElement('div');
                partyHeader.className = 'party-header';
                
                const partyOption = document.createElement('div');
                partyOption.className = 'party-option';
                
                const partyInput = document.createElement('input');
                partyInput.type = 'number';
                partyInput.min = '1';
                partyInput.max = '4';
                partyInput.className = 'party-preference';
                partyInput.placeholder = '-';
                partyInput.dataset.party = group.name;
                partyInput.addEventListener('input', function() {
                    handlePartyInput(this);
                });
                
                const partySpan = document.createElement('span');
                partySpan.textContent = group.name;
                
                partyOption.appendChild(partyInput);
                partyOption.appendChild(partySpan);
                partyHeader.appendChild(partyOption);
                aboveColumnDiv.appendChild(partyHeader);
                aboveLineContainer.appendChild(aboveColumnDiv);
                
                // Below the line (candidate voting)
                const belowColumnDiv = document.createElement('div');
                belowColumnDiv.className = 'party-column';
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'party-group';
                
                // Keep original candidate order within each group
                group.candidates.forEach(candidate => {
                    const candidateDiv = document.createElement('div');
                    candidateDiv.className = 'candidate';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '1';
                    input.max = totalCandidates.toString();
                    input.className = 'candidate-preference';
                    input.placeholder = '-';
                    input.dataset.candidate = candidate;
                    input.addEventListener('input', function() {
                        handleCandidateInput(this);
                    });
                    
                    const span = document.createElement('span');
                    span.textContent = candidate;
                    
                    candidateDiv.appendChild(input);
                    candidateDiv.appendChild(span);
                    groupDiv.appendChild(candidateDiv);
                });
                
                belowColumnDiv.appendChild(groupDiv);
                belowLineContainer.appendChild(belowColumnDiv);
            });
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ===== INPUT HANDLERS =====
        function handlePartyInput(input) {
            const value = input.value.trim();
            
            if (value === "") {
                return;
            }
            
            // Validate party input
            const numValue = parseInt(value);
            if (isNaN(numValue)) {
                input.value = "";
                return;
            }
            
            if (numValue < 1 || numValue > 4) {
                errorMsg.textContent = "Party preferences must be between 1 and 4.";
                input.value = "";
                return;
            }
            
            // Check if candidate voting was already started
            const hasCandidateVotes = Array.from(candidatePreferences).some(c => c.value !== "");
            if (hasCandidateVotes) {
                errorMsg.textContent = "You can't vote both above and below the line. Please choose one method.";
                input.value = "";
                return;
            }
            
            // Clear other party inputs with the same value
            partyPreferences.forEach(p => {
                if (p !== input && p.value === value) {
                    p.value = "";
                }
            });
            
            errorMsg.textContent = "";
        }

        function handleCandidateInput(input) {
            const value = input.value.trim();
            
            if (value === "") {
                return;
            }
            
            // Check if party voting was already started
            const hasPartyVotes = Array.from(partyPreferences).some(p => p.value !== "");
            if (hasPartyVotes) {
                errorMsg.textContent = "You can't vote both above and below the line. Please choose one method.";
                input.value = "";
                return;
            }
            
            // Validate candidate input
            const numValue = parseInt(value);
            if (isNaN(numValue)) {
                input.value = "";
                return;
            }
            
            if (numValue < 1 || numValue > totalCandidates) {
                errorMsg.textContent = `Preferences must be between 1 and ${totalCandidates}.`;
                input.value = "";
                return;
            }
            
            // Check for duplicates
            candidatePreferences.forEach(c => {
                if (c !== input && c.value === value) {
                    errorMsg.textContent = `Number ${value} is used more than once.`;
                    c.value = "";
                }
            });
        }

        // ===== VALIDATION FUNCTIONS =====
        function validateBallot() {
            if (!usernameInput.value.trim()) {
                return "Error: Please enter your username.";
            }
            
            // Validate referendum inputs
            const referendum1Value = referendum1Input.value.trim().toLowerCase();
            const referendum2Value = referendum2Input.value.trim().toLowerCase();
            
            if (!referendum1Value || !referendum2Value) {
                return "Error: Please vote on both referendum propositions (yes or no).";
            }
            
            if (referendum1Value !== "yes" && referendum1Value !== "no") {
                return "Error: Referendum 1 must be 'yes' or 'no'.";
            }
            
            if (referendum2Value !== "yes" && referendum2Value !== "no") {
                return "Error: Referendum 2 must be 'yes' or 'no'.";
            }
            
            // Check voting method
            const partyVotes = Array.from(partyPreferences).filter(p => p.value !== "");
            const candidateVotes = Array.from(candidatePreferences).filter(c => c.value !== "");
            
            if (partyVotes.length > 0 && candidateVotes.length > 0) {
                return "Error: Please vote either above OR below the line, not both.";
            }
            
            // If voting above the line (parties)
            if (partyVotes.length > 0) {
                // Check if all 4 parties are numbered
                if (partyVotes.length !== 4) {
                    return "Error: Please number all 4 party boxes (1-4) when voting above the line.";
                }
                
                // Check for duplicates
                const partyNumbers = partyVotes.map(p => parseInt(p.value));
                const uniqueNumbers = new Set(partyNumbers);
                if (partyNumbers.length !== uniqueNumbers.size) {
                    return "Error: Duplicate party preferences detected.";
                }
                
                // Check numbers are 1-4
                const invalidNumbers = partyNumbers.filter(n => n < 1 || n > 4);
                if (invalidNumbers.length > 0) {
                    return "Error: Party preferences must be between 1 and 4.";
                }
                
                return ''; // No error
            }
            // If voting below the line (candidates)
            else if (candidateVotes.length > 0) {
                // Check minimum 8 candidates
                if (candidateVotes.length < 8) {
                    return `Error: Please number at least 8 candidates (1-${totalCandidates}) when voting below the line.`;
                }
                
                // Check for duplicates
                const candidateNumbers = candidateVotes.map(c => parseInt(c.value));
                const uniqueNumbers = new Set(candidateNumbers);
                if (candidateNumbers.length !== uniqueNumbers.size) {
                    return "Error: Duplicate candidate preferences detected.";
                }
                
                // Check numbers are 1-22
                const invalidNumbers = candidateNumbers.filter(n => n < 1 || n > totalCandidates);
                if (invalidNumbers.length > 0) {
                    return `Error: Candidate preferences must be between 1 and ${totalCandidates}.`;
                }
                
                return ''; // No error
            }
            else {
                return "Error: Please vote either above the line (for parties) or below the line (for candidates).";
            }
        }

        // ===== GOOGLE SHEETS SUBMISSION =====
        function submitToGoogleSheet(username, votes, isPartyVote, referendum1, referendum2) {
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzWINxRnQVYjWafOzCyTMSU96el7omcYDB-iF85paWJ5QDHSYpdG8x_lEtUi_1E68RK/exec";
            
            // Show loading state
            errorMsg.textContent = "Submitting...";
            errorMsg.style.color = "blue";
            submitBtn.disabled = true;
            
            fetch(googleScriptUrl, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    username: username.trim(),
                    votes: votes.map(vote => ({
                        candidate: vote.candidate,
                        preference: parseInt(vote.preference) || 0,
                        isParty: isPartyVote
                    })),
                    referendum1: referendum1,
                    referendum2: referendum2
                })
            })
            .then(() => {
                errorMsg.textContent = "Ballot submitted successfully!";
                errorMsg.style.color = "green";
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = "https://example.com/voting_complete";
                }, 2000);
            })
            .catch((error) => {
                errorMsg.textContent = "Error submitting ballot. Please try again.";
                errorMsg.style.color = "red";
                submitBtn.disabled = false;
                console.error("Error:", error);
            });
        }

        // ===== EVENT LISTENERS =====
        submitBtn.addEventListener('click', function() {
            const validationError = validateBallot();
            if (validationError) {
                errorMsg.textContent = validationError;
                errorMsg.style.color = "red";
                return;
            }
            
            // Determine if this is a party or candidate vote
            const partyVotes = Array.from(partyPreferences).filter(p => p.value !== "");
            const isPartyVote = partyVotes.length > 0;
            
            const votes = isPartyVote 
                ? Array.from(partyPreferences)
                      .filter(p => p.value !== "")
                      .map(input => ({
                          candidate: input.dataset.party,
                          preference: input.value
                      }))
                : Array.from(candidatePreferences)
                      .filter(c => c.value !== "")
                      .map(input => ({
                          candidate: input.dataset.candidate,
                          preference: input.value
                      }));
            
            // Get referendum values
            const referendum1Value = referendum1Input.value.trim().toLowerCase();
            const referendum2Value = referendum2Input.value.trim().toLowerCase();
            
            submitToGoogleSheet(
                usernameInput.value.trim(), 
                votes, 
                isPartyVote,
                referendum1Value,
                referendum2Value
            );
        });

        // Initialize the randomized ballot
        initializeBallot();
    });
</script>
</body>
</html>
