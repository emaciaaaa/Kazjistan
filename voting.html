<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Ballot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .ballot {
            background-color: white;
            border: 2px solid #000;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .ballot-container {
            display: flex;
            gap: 15px;
        }
        .party-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .party-header {
            border: 2px solid #000;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            background-color: #f0f0f0;
        }
        .party-group {
            border: 2px solid #000;
            padding: 15px;
        }
        .party-option {
            display: flex;
            align-items: center;
            margin: 10px 0;
            justify-content: center;
        }
        .party-option input {
            width: 40px;
            height: 30px;
            margin-right: 10px;
            text-align: center;
            font-size: 16px;
        }
        .candidate {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .candidate input {
            width: 40px;
            height: 30px;
            margin-right: 10px;
            text-align: center;
            font-size: 16px;
        }
        .error {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        button {
            display: block;
            margin: 20px auto 0;
            padding: 10px 20px;
            background-color: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0055aa;
        }
        .instructions {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        .username-input {
            margin-top: 20px;
            text-align: center;
        }
        .username-input input {
            padding: 8px;
            font-size: 16px;
            width: 200px;
        }
        .voting-method {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        .divider {
            border-top: 3px solid black;
            margin: 20px 0;
            position: relative;
        }
        .divider-text {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            font-weight: bold;
        }
        .above-the-line {
            margin-bottom: 30px;
        }
        .below-the-line {
            margin-top: 30px;
        }
        .requirement {
            font-style: italic;
            color: #555;
            margin-top: 5px;
        }
        .referendum {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #000;
            background-color: #f9f9f9;
        }
        .referendum h3 {
            margin-top: 0;
            color: #333;
        }
        .referendum p {
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .referendum-input {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }
        .referendum-input input {
            width: 100px;
            height: 30px;
            padding: 5px;
            font-size: 16px;
            text-align: center;
            margin-right: 10px;
        }
        .referendum-input label {
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .ballot-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="ballot">
        <h2 style="text-align: center;">Official Election Ballot</h2>
        
        <div class="voting-method">VOTE EITHER ABOVE THE LINE (FOR PARTIES) OR BELOW THE LINE (FOR CANDIDATES) - NOT BOTH</div>
        
        <!-- Above the line section -->
        <div class="above-the-line">
            <p class="instructions">ABOVE THE LINE - VOTE FOR PARTIES</p>
            <p class="requirement">(Number ALL 4 boxes in order of preference 1-4)</p>
            <div class="ballot-container" id="above-line-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Divider line -->
        <div class="divider">
            <span class="divider-text">OR</span>
        </div>
        
        <!-- Below the line section -->
        <div class="below-the-line">
            <p class="instructions">BELOW THE LINE - VOTE FOR CANDIDATES</p>
            <p class="requirement">(Number AT LEAST 8 boxes in order of preference 1-22)</p>
            <div class="ballot-container" id="below-line-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Referendum Propositions -->
        <div class="referendum">
            <h3>Referendum Proposition 1</h3>
            <p>Do you agree with inserting the following article after twenty-eight, thereby shifting each following article by one digit?</p>
            <p><strong>Article Twenty-Nine:</strong> The Judiciary shall not unduly delay proceedings without just cause, and must adjudicate cases in a timely manner. Justices found to partake in deliberate or unreasonable postponements of proceedings are to be removed by Parliament.</p>
            <div class="referendum-input">
                <input type="text" id="referendum1" placeholder="yes or no" pattern="^(yes|no)$" required>
                <label for="referendum1">Your vote (yes/no):</label>
            </div>
        </div>

        <div class="referendum">
            <h3>Referendum Proposition 2</h3>
            <p>Do you agree with inserting the following article after fifty-seven, thereby shifting each following article by one digit?</p>
            <p><strong>Fifty-Eight:</strong> The government shall not establish, impose, or enforce any centralised economic, monetary, or financial system, nor shall it create institutions, regulations, or mechanisms that effectively constitute such a system, whether in whole or in part, directly or indirectly. No government or citizen shall institute financial, monetary, currency, or economic systems within Kazjistan, including central banks, private financial institutions, or external organizations purporting to act on behalf of the Kazji state. This prohibition extends to all claims of state endorsement, de facto financial structures, or circumvention through external entities.</p>
            <div class="referendum-input">
                <input type="text" id="referendum2" placeholder="yes or no" pattern="^(yes|no)$" required>
                <label for="referendum2">Your vote (yes/no):</label>
            </div>
        </div>

        <!-- Username Input -->
        <div class="username-input">
            <label for="username">Username:</label>
            <input type="text" id="username" required placeholder="Enter your username">
        </div>
        
        <div class="error" id="error-message"></div>
        <button id="submit-ballot">Submit Ballot</button>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const errorMsg = document.getElementById('error-message');
        const submitBtn = document.getElementById('submit-ballot');
        const usernameInput = document.getElementById('username');
        const aboveLineContainer = document.getElementById('above-line-container');
        const belowLineContainer = document.getElementById('below-line-container');
        const referendum1Input = document.getElementById('referendum1');
        const referendum2Input = document.getElementById('referendum2');
        
        // Party data
        const parties = [
            { name: "WHIG" },
            { name: "PROGRESSIVE" },
            { name: "REVOLT!" },
            { name: "MEG" }
        ];
        
        // Candidate data
        const candidateGroups = [
            {
                name: "WHIG",
                candidates: ["Joe Sane", "Elite", "Zelvrix", "Hope", "EstoBlake", "Zeynep", "Fevsear", "Goodquestion"]
            },
            {
                name: "PROGRESSIVE",
                candidates: ["Igor Witback", "Axell Nevylym", "Timus Maximus", "Emacia", "Fixie", "Cyrzed", "Aeropitz", "Baraa", "Coca-Cola King", "Dinobop"]
            },
            {
                name: "REVOLT!",
                candidates: ["Clover", "Luci", "Cisco"]
            },
            {
                name: "MEG",
                candidates: ["Meg"]
            }
        ];
        const totalCandidates = candidateGroups.reduce((sum, group) => sum + group.candidates.length, 0);

        // Initialize ballot
        initializeBallot();

        function initializeBallot() {
            // Shuffle party order
            const shuffledParties = shuffleArray([...parties]);
            const shuffledGroups = shuffleArray([...candidateGroups]);
            
            // Clear containers
            aboveLineContainer.innerHTML = '';
            belowLineContainer.innerHTML = '';
            
            // Create above-the-line (party) voting
            shuffledParties.forEach(party => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'party-column';
                
                const partyHeader = document.createElement('div');
                partyHeader.className = 'party-header';
                
                const partyOption = document.createElement('div');
                partyOption.className = 'party-option';
                
                const partyInput = document.createElement('input');
                partyInput.type = 'number';
                partyInput.min = '1';
                partyInput.max = '4';
                partyInput.className = 'party-preference';
                partyInput.placeholder = '-';
                partyInput.dataset.party = party.name;
                partyInput.addEventListener('input', handlePartyInput);
                
                const partySpan = document.createElement('span');
                partySpan.textContent = party.name;
                
                partyOption.appendChild(partyInput);
                partyOption.appendChild(partySpan);
                partyHeader.appendChild(partyOption);
                columnDiv.appendChild(partyHeader);
                aboveLineContainer.appendChild(columnDiv);
            });
            
            // Create below-the-line (candidate) voting
            shuffledGroups.forEach(group => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'party-column';
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'party-group';
                
                group.candidates.forEach(candidate => {
                    const candidateDiv = document.createElement('div');
                    candidateDiv.className = 'candidate';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '1';
                    input.max = totalCandidates.toString();
                    input.className = 'candidate-preference';
                    input.placeholder = '-';
                    input.dataset.candidate = candidate;
                    input.addEventListener('input', handleCandidateInput);
                    
                    const span = document.createElement('span');
                    span.textContent = candidate;
                    
                    candidateDiv.endChild(input);
                    candidateDiv.endChild(span);
                    groupDiv.endChild(candidateDiv);
                });
                
                columnDiv.endChild(groupDiv);
                belowLineContainer.endChild(columnDiv);
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function handlePartyInput(e) {
            const input = e.target;
            const value = input.value.trim();
            
            if (value === "") {
                errorMsg.textContent = "";
                return;
            }
            
            const numValue = parseInt(value);
            if (isNaN(numValue)) {
                errorMsg.textContent = "Please enter a valid number.";
                input.value = "";
                return;
            }
            
            if (numValue < 1 || numValue > 4) {
                errorMsg.textContent = "Party preferences must be between 1 and 4.";
                input.value = "";
                return;
            }
            
            // Clear duplicate numbers
            document.querySelectorAll('.party-preference').forEach(p => {
                if (p !== input && p.value === value) {
                    p.value = "";
                }
            });
            
            errorMsg.textContent = "";
        }

        function handleCandidateInput(e) {
            const input = e.target;
            const value = input.value.trim();
            
            if (value === "") {
                errorMsg.textContent = "";
                return;
            }
            
            const numValue = parseInt(value);
            if (isNaN(numValue)) {
                errorMsg.textContent = "Please enter a valid number.";
                input.value = "";
                return;
            }
            
            if (numValue < 1 || numValue > totalCandidates) {
                errorMsg.textContent = `Preferences must be between 1 and ${totalCandidates}.`;
                input.value = "";
                return;
            }
            
            // Clear duplicate numbers
            document.querySelectorAll('.candidate-preference').forEach(c => {
                if (c !== input && c.value === value) {
                    c.value = "";
                }
            });
            
            errorMsg.textContent = "";
        }

        function validateBallot() {
            // Basic validation
            if (!usernameInput.value.trim()) {
                return "Error: Please enter your username.";
            }
            
            const referendum1Value = referendum1Input.value.trim().toLowerCase();
            const referendum2Value = referendum2Input.value.trim().toLowerCase();
            
            if (!referendum1Value || !referendum2Value) {
                return "Error: Please vote on both referendum propositions.";
            }
            
            if (!['yes', 'no'].includes(referendum1Value) || !['yes', 'no'].includes(referendum2Value)) {
                return "Error: Referendum votes must be 'yes' or 'no'.";
            }
            
            // Check voting method
            const partyVotes = Array.from(document.querySelectorAll('.party-preference'))
                .filter(p => p.value !== "")
                .map(p => parseInt(p.value));
            
            const candidateVotes = Array.from(document.querySelectorAll('.candidate-preference'))
                .filter(c => c.value !== "")
                .map(c => parseInt(c.value));
            
            // If both sections have votes
            if (partyVotes.length > 0 && candidateVotes.length > 0) {
                return "Error: Please vote either above OR below the line, not both.";
            }
            
            // If voting above the line
            if (partyVotes.length > 0) {
                if (partyVotes.length !== 4) {
                    return "Error: Please number all 4 party boxes (1-4).";
                }
                
                if (new Set(partyVotes).size !== partyVotes.length) {
                    return "Error: Duplicate party preferences detected.";
                }
                
                if (partyVotes.some(n => n < 1 || n > 4)) {
                    return "Error: Party preferences must be between 1 and 4.";
                }
                
                return ""; // Valid above-the-line vote
            }
            
            // If voting below the line
            if (candidateVotes.length > 0) {
                if (candidateVotes.length < 8) {
                    return `Error: Please number at least 8 candidates (you numbered ${candidateVotes.length}).`;
                }
                
                if (new Set(candidateVotes).size !== candidateVotes.length) {
                    return "Error: Duplicate candidate preferences detected.";
                }
                
                if (candidateVotes.some(n => n < 1 || n > totalCandidates)) {
                    return `Error: Candidate preferences must be between 1 and ${totalCandidates}.`;
                }
                
                return ""; // Valid below-the-line vote
            }
            
            // If no votes at all
            return "Error: Please vote either above or below the line.";
        }

        function submitToGoogleSheet(username, votes, isPartyVote, referendum1, referendum2) {
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbx5kxcF0DF2maDC-THWPBklnXcZy7Og9iy2BMELJvrB2Wp2ZhEEq85C9MWd6rO2Kma9/exec";
            
            errorMsg.textContent = "Submitting...";
            errorMsg.style.color = "blue";
            submitBtn.disabled = true;
            
            fetch(googleScriptUrl, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    username: username.trim(),
                    votes: votes.map(vote => ({
                        candidate: vote.candidate,
                        preference: parseInt(vote.preference) || 0,
                        isParty: isPartyVote
                    })),
                    referendum1: referendum1,
                    referendum2: referendum2
                })
            })
            .then(() => {
                errorMsg.textContent = "Ballot submitted successfully!";
                errorMsg.style.color = "green";
                setTimeout(() => {
                    window.location.href = "https://example.com/voting_complete";
                }, 2000);
            })
            .catch((error) => {
                errorMsg.textContent = "Error submitting ballot. Please try again.";
                errorMsg.style.color = "red";
                submitBtn.disabled = false;
                console.error("Error:", error);
            });
        }

        submitBtn.addEventListener('click', function() {
            const error = validateBallot();
            if (error) {
                errorMsg.textContent = error;
                errorMsg.style.color = "red";
                return;
            }
            
            const isPartyVote = document.querySelectorAll('.party-preference')
                .some(p => p.value !== "");
            
            const votes = isPartyVote
                ? Array.from(document.querySelectorAll('.party-preference'))
                    .filter(p => p.value !== "")
                    .map(p => ({
                        candidate: p.dataset.party,
                        preference: p.value
                    }))
                : Array.from(document.querySelectorAll('.candidate-preference'))
                    .filter(c => c.value !== "")
                    .map(c => ({
                        candidate: c.dataset.candidate,
                        preference: c.value
                    }));
            
            submitToGoogleSheet(
                usernameInput.value.trim(),
                votes,
                isPartyVote,
                referendum1Input.value.trim().toLowerCase(),
                referendum2Input.value.trim().toLowerCase()
            );
        });
    });
</script>
</body>
</html>
