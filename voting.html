<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const errorMsg = document.getElementById('error-message');
        const submitBtn = document.getElementById('submit-ballot');
        const usernameInput = document.getElementById('username');
        const referendum1Input = document.getElementById('referendum1');
        const referendum2Input = document.getElementById('referendum2');
        
        // Candidate data
        const candidateGroups = [
            {
                name: "WHIG",
                candidates: ["Joe Sane", "Elite", "Zelvrix", "Hope", "EstoBlake", "Zeynep", "Fevsear", "Goodquestion"]
            },
            {
                name: "PROGRESSIVE",
                candidates: ["Igor Witback", "Axell Nevylym", "Timus Maximus", "Emacia", "Fixie", "Cyrzed", "Aeropitz", "Baraa", "Coca-Cola King", "Dinobop"]
            },
            {
                name: "REVOLT!",
                candidates: ["Clover", "Luci", "Cisco"]
            },
            {
                name: "MEG",
                candidates: ["Meg"]
            }
        ];

        // Initialize ballot
        initializeBallot();

        function initializeBallot() {
            const aboveLineContainer = document.querySelector('.above-the-line .ballot-container');
            const belowLineContainer = document.querySelector('.below-the-line .ballot-container');
            
            // Clear existing content
            aboveLineContainer.innerHTML = '';
            belowLineContainer.innerHTML = '';
            
            // Create party columns
            candidateGroups.forEach(group => {
                // Above the line (party voting)
                const aboveColumnDiv = document.createElement('div');
                aboveColumnDiv.className = 'party-column';
                
                const partyHeader = document.createElement('div');
                partyHeader.className = 'party-header';
                
                const partyOption = document.createElement('div');
                partyOption.className = 'party-option';
                
                const partyInput = document.createElement('input');
                partyInput.type = 'number';
                partyInput.min = '1';
                partyInput.max = '4';
                partyInput.className = 'party-preference';
                partyInput.placeholder = '-';
                partyInput.dataset.party = group.name;
                
                const partySpan = document.createElement('span');
                partySpan.textContent = group.name;
                
                partyOption.appendChild(partyInput);
                partyOption.appendChild(partySpan);
                partyHeader.appendChild(partyOption);
                aboveColumnDiv.appendChild(partyHeader);
                aboveLineContainer.appendChild(aboveColumnDiv);
                
                // Below the line (candidate voting)
                const belowColumnDiv = document.createElement('div');
                belowColumnDiv.className = 'party-column';
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'party-group';
                
                group.candidates.forEach(candidate => {
                    const candidateDiv = document.createElement('div');
                    candidateDiv.className = 'candidate';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '1';
                    input.max = '22';
                    input.className = 'candidate-preference';
                    input.placeholder = '-';
                    input.dataset.candidate = candidate;
                    
                    const span = document.createElement('span');
                    span.textContent = candidate;
                    
                    candidateDiv.appendChild(input);
                    candidateDiv.appendChild(span);
                    groupDiv.appendChild(candidateDiv);
                });
                
                belowColumnDiv.appendChild(groupDiv);
                belowLineContainer.appendChild(belowColumnDiv);
            });
        }

        function validateBallot() {
            // 1. Validate username
            if (!usernameInput.value.trim()) {
                return "Error: Please enter your username.";
            }

            // 2. Validate referendums
            const referendum1Value = referendum1Input.value.trim().toLowerCase();
            const referendum2Value = referendum2Input.value.trim().toLowerCase();
            
            if (!referendum1Value || !referendum2Value) {
                return "Error: Please vote on both referendum propositions.";
            }
            
            if (!['yes', 'no'].includes(referendum1Value) || !['yes', 'no'].includes(referendum2Value)) {
                return "Error: Referendum votes must be 'yes' or 'no'.";
            }

            // 3. Check voting method
            const partyInputs = document.querySelectorAll('.party-preference');
            const candidateInputs = document.querySelectorAll('.candidate-preference');
            
            const partyVotes = Array.from(partyInputs).filter(p => p.value !== "");
            const candidateVotes = Array.from(candidateInputs).filter(c => c.value !== "");
            
            // 4. Check for mixed voting
            if (partyVotes.length > 0 && candidateVotes.length > 0) {
                return "Error: Please vote either above OR below the line, not both.";
            }

            // 5. Validate party votes
            if (partyVotes.length > 0) {
                if (partyVotes.length !== 4) {
                    return "Error: Please number all 4 party boxes (1-4).";
                }
                
                const partyNumbers = partyVotes.map(p => parseInt(p.value));
                const uniqueNumbers = new Set(partyNumbers);
                
                if (uniqueNumbers.size !== partyNumbers.length) {
                    return "Error: Duplicate party preferences detected.";
                }
                
                if (partyNumbers.some(n => n < 1 || n > 4)) {
                    return "Error: Party preferences must be between 1 and 4.";
                }
                
                return ""; // Success
            }

            // 6. Validate candidate votes
            if (candidateVotes.length > 0) {
                if (candidateVotes.length < 8) {
                    return `Error: Please number at least 8 candidates (you numbered ${candidateVotes.length}).`;
                }
                
                const candidateNumbers = candidateVotes.map(c => parseInt(c.value));
                const uniqueNumbers = new Set(candidateNumbers);
                
                if (uniqueNumbers.size !== candidateNumbers.length) {
                    return "Error: Duplicate candidate preferences detected.";
                }
                
                if (candidateNumbers.some(n => n < 1 || n > 22)) {
                    return "Error: Candidate preferences must be between 1 and 22.";
                }
                
                return ""; // Success
            }

            // 7. No votes case
            return "Error: Please vote either above or below the line.";
        }

        async function submitToGoogleSheet(data) {
            // Replace with your Google Apps Script web app URL
            const scriptUrl = "https://script.google.com/macros/s/AKfycbx5kxcF0DF2maDC-THWPBklnXcZy7Og9iy2BMELJvrB2Wp2ZhEEq85C9MWd6rO2Kma9/exec";
            
            try {
                errorMsg.textContent = "Submitting your ballot...";
                errorMsg.style.color = "blue";
                submitBtn.disabled = true;
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Note: With no-cors mode, we can't read the response
                errorMsg.textContent = "Ballot submitted successfully!";
                errorMsg.style.color = "green";
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = "https://kazjistan.org/voting_complete";
                }, 2000);
                
            } catch (error) {
                errorMsg.textContent = "Error submitting ballot. Please try again.";
                errorMsg.style.color = "red";
                submitBtn.disabled = false;
                console.error('Error:', error);
            }
        }

        submitBtn.addEventListener('click', async function() {
            const error = validateBallot();
            if (error) {
                errorMsg.textContent = error;
                errorMsg.style.color = "red";
                return;
            }
            
            // Determine vote type
            const isPartyVote = document.querySelectorAll('.party-preference[value!=""]').length > 0;
            
            // Prepare vote data
            const votes = isPartyVote
                ? Array.from(document.querySelectorAll('.party-preference[value!=""]'))
                    .map(input => ({
                        candidate: input.dataset.party,
                        preference: input.value
                    }))
                : Array.from(document.querySelectorAll('.candidate-preference[value!=""]'))
                    .map(input => ({
                        candidate: input.dataset.candidate,
                        preference: input.value
                    }));
            
            // Prepare complete data package
            const formData = {
                username: usernameInput.value.trim(),
                votes: votes,
                isPartyVote: isPartyVote,
                referendum1: referendum1Input.value.trim().toLowerCase(),
                referendum2: referendum2Input.value.trim().toLowerCase(),
                timestamp: new Date().toISOString()
            };
            
            // Submit to Google Apps Script
            await submitToGoogleSheet(formData);
        });

        // Input validation handlers
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('party-preference')) {
                handlePartyInput(e.target);
            } else if (e.target.classList.contains('candidate-preference')) {
                handleCandidateInput(e.target);
            }
        });

        function handlePartyInput(input) {
            const value = input.value.trim();
            if (value === "") return;
            
            const numValue = parseInt(value);
            if (isNaN(numValue) || numValue < 1 || numValue > 4) {
                errorMsg.textContent = "Party preferences must be between 1 and 4.";
                input.value = "";
                return;
            }
            
            // Clear duplicates
            document.querySelectorAll('.party-preference').forEach(p => {
                if (p !== input && p.value === value) {
                    p.value = "";
                }
            });
            
            errorMsg.textContent = "";
        }

        function handleCandidateInput(input) {
            const value = input.value.trim();
            if (value === "") return;
            
            const numValue = parseInt(value);
            if (isNaN(numValue) || numValue < 1 || numValue > 22) {
                errorMsg.textContent = "Preferences must be between 1 and 22.";
                input.value = "";
                return;
            }
            
            // Clear duplicates
            document.querySelectorAll('.candidate-preference').forEach(c => {
                if (c !== input && c.value === value) {
                    c.value = "";
                }
            });
            
            errorMsg.textContent = "";
        }
    });
</script>
