<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1 August 2025 Election</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .ballot {
            background-color: white;
            border: 2px solid #000;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .parties-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .party-column {
            flex: 1;
            margin: 0 10px;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .party-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f0f0f0;
            border-bottom: 2px solid #000;
        }
        .candidate {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .candidate input {
            width: 40px;
            height: 30px;
            margin-right: 10px;
            text-align: center;
            font-size: 16px;
        }
        .candidate-info {
            display: flex;
            flex-direction: column;
        }
        .candidate-name {
            font-weight: bold;
            font-size: 16px;
        }
        .candidate-party {
            font-size: 12px;
            color: #555;
            margin-top: 2px;
        }
        .error {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        button {
            display: block;
            margin: 20px auto 0;
            padding: 10px 20px;
            background-color: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0055aa;
        }
        .instructions {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        .username-input {
            margin-top: 20px;
            text-align: center;
        }
        .username-input input {
            padding: 8px;
            font-size: 16px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="ballot">
        <h2 style="text-align: center;">1 August 2025 Election</h2>
        <p class="instructions">Number at least 8 boxes in order of preference (1 to 22).</p>
        
        <div class="parties-container" id="parties-container">
            <!-- Party columns will be inserted here by JavaScript -->
        </div>

        <!-- Username Input -->
        <div class="username-input">
            <label for="username">Username:</label>
            <input type="text" id="username" required placeholder="Enter your username">
        </div>
        
        <div class="error" id="error-message"></div>
        <button id="submit-ballot">Submit Ballot</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const errorMsg = document.getElementById('error-message');
            const submitBtn = document.getElementById('submit-ballot');
            const usernameInput = document.getElementById('username');
            const partiesContainer = document.getElementById('parties-container');
            const totalCandidates = 22; // Updated total number of candidates
            const minPreferences = 8; // Minimum number of preferences required
            
            // Candidate data with party affiliations in exact order
            const partyLists = {
                "Whig": [
                    { name: "Joe Sane", party: "Whig" },
                    { name: "Elite", party: "Whig" },
                    { name: "Zelvrix", party: "Whig" },
                    { name: "Hope", party: "Whig" },
                    { name: "Estoblake", party: "Whig" },
                    { name: "CSGplayz", party: "Whig" },
                    { name: "Fevsear", party: "Whig" },
                    { name: "Zeynep", party: "Whig" },
                    { name: "Goodquestion", party: "Whig" }
                ],
                "Revolt!": [
                    { name: "Clover", party: "Revolt!" },
                    { name: "Luci", party: "Revolt!" },
                    { name: "Cisco", party: "Revolt!" }
                ],
                "Progressive": [
                    { name: "Witback", party: "Progressive" },
                    { name: "Axell Nevylym", party: "Progressive" },
                    { name: "Timus Maximus", party: "Progressive" },
                    { name: "Emacia", party: "Progressive" },
                    { name: "Fixie", party: "Progressive" },
                    { name: "Cyrzed", party: "Progressive" },
                    { name: "Aeropitz", party: "Progressive" },
                    { name: "Baraa", party: "Progressive" },
                    { name: "Coca-Cola King", party: "Progressive" },
                    { name: "Dinobop", party: "Progressive" }
                ],
                "Independent": [
                    { name: "Meg", party: "Independent" }
                ]
            };
            
            // Initialize ballot with rotating party order but fixed candidate order
            function initializeBallot() {
                // Clear existing content
                partiesContainer.innerHTML = '';
                
                // Get party names and shuffle their order (Robson Rotation for parties)
                const partyNames = Object.keys(partyLists);
                const shuffledPartyNames = shuffleArray([...partyNames]);
                
                // Create columns for each party in shuffled order
                shuffledPartyNames.forEach(party => {
                    const candidates = partyLists[party];
                    const column = document.createElement('div');
                    column.className = 'party-column';
                    
                    // Add party header
                    const header = document.createElement('div');
                    header.className = 'party-header';
                    header.textContent = party;
                    column.appendChild(header);
                    
                    // Add candidates in fixed order
                    candidates.forEach(candidate => {
                        const candidateDiv = document.createElement('div');
                        candidateDiv.className = 'candidate';
                        
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.min = '1';
                        input.max = totalCandidates.toString();
                        input.className = 'preference';
                        input.placeholder = '-';
                        input.dataset.candidate = candidate.name;
                        
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'candidate-info';
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'candidate-name';
                        nameSpan.textContent = candidate.name;
                        
                        const partySpan = document.createElement('span');
                        partySpan.className = 'candidate-party';
                        partySpan.textContent = candidate.party;
                    
                        infoDiv.appendChild(nameSpan);
                        infoDiv.appendChild(partySpan);
                        candidateDiv.appendChild(input);
                        candidateDiv.appendChild(infoDiv);
                        column.appendChild(candidateDiv);
                    });
                    
                    partiesContainer.appendChild(column);
                });
            }
            
            // Fisher-Yates shuffle algorithm for party rotation
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            // ===== VALIDATION FUNCTIONS =====
            function validateInput(input) {
                const value = parseInt(input.value);
                if (isNaN(value)) return '';
                
                const inputs = document.querySelectorAll('.preference');
                
                if (value > totalCandidates) return `Error: Maximum preference is ${totalCandidates}.`;
                
                let duplicates = 0;
                inputs.forEach(otherInput => {
                    if (otherInput !== input && otherInput.value === input.value) {
                        duplicates++;
                    }
                });
                
                if (duplicates > 0) return `Error: Number ${input.value} is used more than once.`;
                return '';
            }

            function validateBallot() {
                const inputs = Array.from(document.querySelectorAll('.preference'));
                
                if (!usernameInput.value.trim()) return "Error: Please enter your username.";
                
                // Count how many preferences have been entered
                const numberedPreferences = inputs.filter(input => input.value !== "").length;
                
                if (numberedPreferences < minPreferences) {
                    return `Error: You must number at least ${minPreferences} candidates.`;
                }
                
                // Get all numbered preferences
                const numbers = inputs
                    .filter(input => input.value !== "")
                    .map(input => parseInt(input.value));
                
                // Check for duplicates among numbered preferences
                if (numbers.length !== new Set(numbers).size) {
                    return "Error: Duplicate numbers detected.";
                }
                
                // Check for numbers out of range
                const invalidNumbers = numbers.filter(n => n < 1 || n > totalCandidates);
                if (invalidNumbers.length > 0) {
                    return `Error: Preferences must be between 1 and ${totalCandidates}.`;
                }
                
                // Check for gaps in numbering (optional - remove if not needed)
                const sortedNumbers = [...numbers].sort((a, b) => a - b);
                for (let i = 0; i < sortedNumbers.length; i++) {
                    if (sortedNumbers[i] !== i + 1) {
                        return "Error: Preferences should be sequential starting from 1 (no gaps).";
                    }
                }
                
                return '';
            }

            // ===== GOOGLE SHEETS SUBMISSION =====
        function submitToGoogleSheet(username, votes) {
    const googleScriptUrl = "https://script.google.com/macros/s/AKfycbyghWRZoWoRE0ePplAI1wOUVV3z-oYjkwH38LknBQZwDWHx14EsqXrEKQ7-2r11Rj_i/exec";
    
    errorMsg.textContent = "Submitting...";
    errorMsg.style.color = "blue";
    submitBtn.disabled = true;
    
    // Add these options to your fetch
    const options = {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ 
            username: username.trim(),
            votes: votes.map(vote => ({
                candidate: vote.candidate,
                preference: parseInt(vote.preference) || 0
            }))
        })
    };
    
    fetch(googleScriptUrl, options)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            errorMsg.textContent = "Ballot submitted successfully!";
            errorMsg.style.color = "green";
            setTimeout(() => {
                window.location.href = "https://www.kazjistan.org/voting_complete";
            }, 2000);
        } else {
            throw new Error(data.error || "Unknown error");
        }
    })
    .catch((error) => {
        errorMsg.textContent = `Error: ${error.message}`;
        errorMsg.style.color = "red";
        submitBtn.disabled = false;
        console.error("Error:", error);
    });
}
            }

            // ===== EVENT LISTENERS =====
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('preference')) {
                    errorMsg.textContent = validateInput(e.target);
                }
            });
            
            submitBtn.addEventListener('click', function() {
                const validationError = validateBallot();
                if (validationError) {
                    errorMsg.textContent = validationError;
                    errorMsg.style.color = "red";
                    return;
                }
                
                const votes = Array.from(document.querySelectorAll('.preference'))
                    .filter(input => input.value !== "") // Only include numbered preferences
                    .map(input => ({
                        candidate: input.dataset.candidate,
                        preference: input.value
                    }));
                
                submitToGoogleSheet(usernameInput.value.trim(), votes);
            });

            // Initialize the ballot with rotating party order but fixed candidate order
            initializeBallot();
        });
    </script>
</body>
</html>
